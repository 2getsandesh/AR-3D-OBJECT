<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Target AR Viewer</title>

    <!-- Importmap for module dependencies -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

      // Initialize the MindARThree with the container and image target
      const mindarThree = new MindARThree({
        container: document.querySelector("#container"),
        imageTargetSrc: "targets.mind" // Path to your multi-target .mind file
      });

      const { renderer, scene, camera } = mindarThree;

      // Lighting for 3D models
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1).normalize();
      scene.add(directionalLight);

      // GLTF Loader to load 3D models
      const loader = new GLTFLoader();

      // Helper function to add feature image alongside the 3D model
      const addFeatureImage = (anchor, imageUrl) => {
        const textureLoader = new THREE.TextureLoader();
        const planeGeometry = new THREE.PlaneGeometry(5, 3);

        textureLoader.load(imageUrl, (texture) => {
          const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
          const featurePlane = new THREE.Mesh(planeGeometry, material);

          featurePlane.position.set(0,0, -0.75); // Position the feature below the 3D model
          anchor.group.add(featurePlane);
        });
      };

      // Setup AR Anchors for each target

      // 1. Drone Target (index 0)
      const droneAnchor = mindarThree.addAnchor(0);
      loader.load('Drone.glb', (gltf) => {
        const droneModel = gltf.scene;
        droneModel.scale.set(1.25, 1.25, 1.25);
        droneModel.position.set(0, 0, 0);
        droneAnchor.group.add(droneModel);

        addFeatureImage(droneAnchor, 'Drone features.png');
      }, undefined, (error) => {
        console.error('Error loading Drone model:', error);
      });

      // 2. Laptop Target (index 1)
      const laptopAnchor = mindarThree.addAnchor(1);
      loader.load('Laptop.glb', (gltf) => {
        const laptopModel = gltf.scene;
        laptopModel.scale.set(0.25, 0.25, 0.25);
        laptopModel.position.set(0, 0, 0);
        laptopAnchor.group.add(laptopModel);

        addFeatureImage(laptopAnchor, 'Laptop features.png');
      }, undefined, (error) => {
        console.error('Error loading Laptop model:', error);
      });

      // 3. Motorcycle Target (index 2)
      const phoneAnchor = mindarThree.addAnchor(2);
      loader.load('Motorcycle.glb', (gltf) => {
        const phoneModel = gltf.scene;
        phoneModel.scale.set(0.1, 0.1, 0.1);
        phoneModel.position.set(0, 0, 0);
        phoneAnchor.group.add(phoneModel);

        addFeatureImage(phoneAnchor, 'Motorcycle features.png');
      }, undefined, (error) => {
        console.error('Error loading Motorcycle model:', error);
      });

      // Start MindAR when Start button is clicked
      const start = async () => {
        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
        document.querySelector("#startPage").style.display = "none"; // Hide start page when AR starts
      };

      // Control Start and Stop functionality
      const startButton = document.querySelector("#startButton");
      startButton.addEventListener("click", () => {
        start();
      });

      const stopButton = document.querySelector("#stopButton");
      stopButton.addEventListener("click", () => {
        mindarThree.stop();
        mindarThree.renderer.setAnimationLoop(null);
        document.querySelector("#startPage").style.display = "flex"; // Show start page when AR stops
      });
    </script>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      #container {
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }
      #startPage {
        width: 100vw;
        height: 100vh;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
      }
      #startPage h1 {
        font-size: 36px;
        margin-bottom: 20px;
        color: #333;
      }
      .control-button {
        padding: 15px 30px;
        margin: 10px;
        font-size: 18px;
        cursor: pointer;
        border: none;
        background-color: #007BFF;
        color: white;
        border-radius: 10px;
        transition: background-color 0.3s ease;
      }
      .control-button:hover {
        background-color: #0056b3;
      }
      #stopButton {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 20;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        background-color: #ff4d4d;
        color: white;
        border-radius: 5px;
      }
      #stopButton:hover {
        background-color: #cc0000;
      }
    </style>
  </head>
  <body>
    <!-- Start Page with "Start AR Experience" button -->
    <div id="startPage">
      <h1>Welcome to the AR Experience</h1>
      <button id="startButton" class="control-button">Start AR Experience</button>
    </div>

    <!-- AR container for rendering -->
    <div id="container"></div>

    <!-- Stop button visible during AR experience -->
    <button id="stopButton">Stop AR Experience</button>
  </body>
</html>
